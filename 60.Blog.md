---
aliases: ['Feral Machines', 'feralmachin.es', 'blog']
---

# 60.Blog Overview
 
 ## Drafts
 
 ```dataview
table title, tags
from "60.Blog/posts" and #draft
sort date desc
```

 ## Posts
```dataview
table title, tags
from "60.Blog/posts"
where true
sort date desc
```
 

## Recent Musings
```dataview
table file.size, file.ctime, tags
from "10.Reverie/14.musings" or "40.Literature"
where file.ctime >= date(today) - dur(7 day)
sort file.size desc
```

# Documentation

## This folder controls the Feral Machines blog

Posts in the `./posts/` subdirectory will be synced with the blog server, at https://feralmachin.es. A `draft` tag prevents those posts from being displayed on the blog's table of contents (home page), but they're still accessible online to anyone who knows, or stumbles across the URL.

## Git submodule

The blog directory contains a separate git submodule, which points to the remote repo at `git@github.com:oblivia-simplex/feral_machines.git`, which is currently public. Which means that this folder note is also public. 

## The `sync_notes.sh` script

The synching is controlled by a `sync_notes.sh` script, that runs as a minutely cronjob. The threshold is set to 600 seconds, which means that a sync only occurs if there has been no file activity (including autosaves) in the notes directory, or any of its subdirectories, in the last 10 minutes. This can be adjusted as needed.


```
#! /bin/bash

THRESHOLD=600
VAULT_DIR="$HOME/notes/"
BLOG_DIR="./60.Blog"
TIMESTAMP="${VAULT_DIR}/.timestamp"
ARG="$1"

function mod_timestamp() {
  find . -path ./.git -prune -false -o -path ${BLOG_DIR}/.git -prune -false -o -path ./INBOX/.git -prune -false -o -type f -printf "%T@\n" | sort -nr | head -n1 
}


function last_commit_timestamp() {
   date -d  $(git log -n1 --pretty=format:%cI) +%s
}


function pull() {
  git pull
  git submodule update --recursive --remote
}

function backup() {

  # First commit and push any changes in the blog directory (submodule)
  cd ${VAULT_DIR}/${BLOG_DIR}
  git pull
  git add -u :/
  find . -path ./.git -prune -false -o -path ./.trash -prune -false -o -type f -exec git add {} \; 
  git commit -m "Cronjob sync of feral machines submodule from notes vault: $(date)" && git push

  cd ${VAULT_DIR}/
  git pull
  # now add the files in the main repo
  find . -path ./.git -prune -false -o \
    -path "${BLOG_DIR}" -prune -false -o \
    -path ./INBOX -prune -false -o \
    -path ./.trash -prune -false -o \
    -path ./.obsidian -prune -false -o \
    -type f -iregex ".*\.\(md\|sh\|bib\|pdf\|tex\|org\|css\|html\)" \
    -exec git add {} \;
  git commit -m "Cronjob sync of notes vault: $(date)" && git push
  true
}


function backup_if_idle() {
  LAST_CHANGE=$(mod_timestamp)
  LAST_COMMIT=$(last_commit_timestamp)
  NOW=$(date +%s)
  TIME_SINCE_LAST_COMMIT=$( echo "($NOW - $LAST_COMMIT)" | bc )
  TIME_SINCE_LAST_CHANGE=$( echo "($NOW - $LAST_CHANGE)" | bc )
  # we want to sync with the repo, only if the time since last change
  # is > threshold (that way we don't commit repeatedly while we're
  # working, since obsidian will autosave changes.
  echo "[+] Last commit: `date -d @$LAST_COMMIT`"
  echo "[+] Last change: `date -d @$LAST_CHANGE`"
  echo "[+] Time since last commit: $TIME_SINCE_LAST_COMMIT seconds"
  echo "[+] Time since last change: $TIME_SINCE_LAST_CHANGE seconds"
  if [ "$ARG" == "--force" ] || (( `echo "($TIME_SINCE_LAST_CHANGE > $THRESHOLD)" | bc` )); then
    if (( `echo "($LAST_COMMIT < $LAST_CHANGE)" | bc` )); then
      echo "[+] Threshold elapsed. Backing up."
      backup
    else
      echo "[+] Threshold elapsed, but everything already backed up."
    fi
  else
    echo "[+] Threshold not yet elapsed."
  fi
}


pushd $VAULT_DIR &> /dev/null
pull
backup_if_idle
popd &> /dev/null
```


Note: I just moved the git repo to the same server the blog is on. I want to see if this works.
Testing something here
